{% load staticfiles %}

<html>
  {% include 'header.html' %}
  <body>
    <div class="wrapper" align="center">
      {% include 'navbar.html' with navbar=navbarOption %}
      <div id="table-container" class="container invisible">
        <table id="searchtable" class="row-border hover order-column" cellspacing="0" width="100%">
        </table>
        <input id="expand-btn" type="submit" value="Expand search" name="expand search">
        <input id="continue-btn" type="submit" value="Continue">
      </div>
    </div>
  </body>
</html>
<script src="{% static 'js/auto-complete.min.js' %}"></script>
<script src="{% static 'js/progressbar.js' %}"></script>
<script src="{% static 'js/searchTableConfig.js' %}"></script>
<script>
// keep track of whether search was expanded
var expanded = false;
var latestSearchTerm = "";
var latestSearchOption = $(".entity-option:checked").val();



// ----  data table  ----
var tableContainer = document.getElementById("table-container");

// function to create searchTable
function makeSearchTable(entityType){
  if ($.fn.DataTable.isDataTable("#searchtable")) {
    $('#searchtable').DataTable().clear().destroy();
    $('#searchtable').empty();
  }
  var tableSettings = searchTableConfig[entityType]['tableSettings'];
  return $('#searchtable').DataTable(tableSettings);
}

// update searchTable
function updateTable(data, table, resKeys, clear){
  console.log("updateTable");
  if (clear) {table.clear();}
  for(var i in data) {
    var newRow = {};
    for(var j in resKeys) {
       key = resKeys[j];
       newRow[j] = data[i][key];
    };
    if (latestSearchOption == 'author'){
    // fields
    fields = "";
    for (var f in newRow[3]) {
      fields += "<li>" + newRow[3][f][0] + " (" + newRow[3][f][1] + ")</li>";
    }
    newRow[3] = "<ul>" + fields + "</ul>";
    // Uppercase first letter
    newRow[4] = newRow[4].charAt(0).toUpperCase() + newRow[4].slice(1);
    }
    table.row.add(newRow);
  };
  table.draw();
}


// ----  images  ----
var imageContainer = document.getElementById("image-container");
var image1 = document.getElementById("image1");
var image2 = document.getElementById("image2");
var image3 = document.getElementById("image3");


var expandButton = document.getElementById("expand-btn");
var inputBar = document.getElementById("name-search-bar");
var searchButton = document.getElementById("search-btn");
var continueButton = document.getElementById("continue-btn");



// ----  listeners  ----

continueButton.addEventListener('click', function(){
  latestSearchOption = $(".entity-option:checked").val();
  var idColumnNumber = searchTableConfig[latestSearchOption].idCol;
  var selected_indexes = searchTable.rows({selected:true})[0];
  var selected_rows = searchTable.rows( selected_indexes ).data().toArray();
  var selected_ids = [];
  var selected_names = [];
  for (var i in selected_rows) {
    selected_ids.push(selected_rows[i][idColumnNumber]);
    selected_names.push(selected_rows[i][0]);
  };

  data = {
    selectedIds: selected_ids.join(),
    selectedNames: selected_names.join(),
    entityType: latestSearchOption,
    load_json: false,
    expanded: expanded,
    name: latestSearchTerm
  };

  console.log(data); 
  window.location.href="/view_papers/?" + $.param(data);
});



function search(exp, clear){
  tableContainer.classList.add("invisible");
  latestSearchOption = $(".entity-option:checked").val();
  var responseKeys = searchTableConfig[latestSearchOption]['responseKeys'];
  if (!exp){
    searchTable = makeSearchTable(latestSearchOption);
    expanded = false;
    latestSearchTerm = inputBar.value;
  } else {
    expanded = true;
  }

  showProgressBar();
  updateProgressBar();
  $.ajax({
    type: "GET",
    url: "/search",
    data: { // input to the views.py - search()
      keyword: latestSearchTerm,
      option: latestSearchOption,
      expand: exp
    },
    success: function (result) { // return data if success
      console.log("searchButton success");
      console.log(result['entities']);
      updateTable(result["entities"], searchTable, responseKeys, clear);
      if (latestSearchOption !== 'author'){expandButton.style.display='none'} else {expandButton.style.display='inline'}
      tableContainer.classList.remove("invisible");
    },
    error: function (result) {
      console.log("searchButton error");
    }
  });
}


// Search Button event handler
searchButton.addEventListener('click', function(){
  search(false, true); // expand: false, clear: true
});


// Search all event handler
expandButton.addEventListener('click', function(){
  search(true, false); // expand: true, clear: false
});

// Search when enter pressed in input bar
inputBar.addEventListener('keypress', function (e) {
    var key = e.which || e.keyCode;
    if (key === 13) { // 13 is enter
      search(false, true);
    }
});




// Just a useful function to check whether one object contains another (for use on lists and strings)
function isInArray(word, list) {
    return list.indexOf(word.toLowerCase()) > -1;
}



function toAcronym(name){
words_to_rm = ['of', 'the', 'and', 'on', 'for']
var w = name.split(' ');
var primary_words = [];
st = '';
for (var j in w){if (!(isInArray(w[j], words_to_rm))){primary_words.push(w[j])}};
  var st = "";
  if (primary_words.length >= 3){
    for (var word in primary_words){
       st += primary_words[word].charAt(0).toUpperCase()
    };
  }
return st;
}



// ----   auto complete   ----
var ac = new autoComplete({
  selector: '#name-search-bar',
  source: function(term, response){
    $.getJSON(
      '/autocomplete?option='+$(".entity-option:checked").val(),
      { q: term },
      function(data){
        term = term.toLowerCase();
        var choices = data;
        var suggestions = [];
        var maxSuggest = 10;
        var termTokens = term.split(" ");


        for (i = 0; i < choices.length && suggestions.length < maxSuggest; i++) {
          var termInName = true;  // ~choices[i].toLowerCase().indexOf(term)
          for (var termIndex in termTokens){
             if (!(~choices[i].toLowerCase().indexOf(termTokens[termIndex]))){termInName = false}
          }
          var acronymInNameAcroynm = ~toAcronym(choices[i]).toLowerCase().indexOf(term.toLowerCase());

          if (termInName | acronymInNameAcroynm){
              var w = choices[i].split(' ');

              var acronym = toAcronym(choices[i]);

              var st = "";
              if (acronym.length >= 3 & $(".entity-option:checked").val() !== 'author'){
                st += acronym;
              st += ' - ';
              };
              st += w.join(' ');
              suggestions.push(st);
          }
        }
        response(suggestions);
      });
  },
  onSelect: function(e, term, item){
    if (term.indexOf(" - ") < 0) {
      inputBar.value = term; 
    } else {
      inputBar.value = term.split(" - ")[1]
    };
    search(false,  true);
  }
});
</script>
