{% load staticfiles %}

<html>
  {% include 'header.html' %}
  <body>
    <div class="wrapper" align="center">
      {% include 'navbar.html' with navbar=navbarOption %}
      <div id="tables-container" class="row" style="width: 80%; max-height: 500px">
        <div id="searchtable-container" class="container" style="float: left; width: 70%; border-right: 1px solid rgb(15,15,15)">
          <table id="searchtable" class="row-border hover order-column" cellspacing="0" width="100%"></table>
        </div>
        <div id="selectiontable-container" class="container" style="float: left; width: 30%; height: 100%">
          <table id="selectiontable" class="row-border hover order-column" cellspacing="0" width="100%"%"></table>
          <input id="continue-btn" type="submit" value="Go" float="bottom">
        </div>
      </div>
    </div>
  </body>
</html>
<script src="{% static 'js/searchTableConfig.js' %}"></script>
<script src="{% static 'js/selectionTableConfig.js' %}"></script>
<script>
// keep track of whether search was expanded
var latestSearchTerm = "";
var latestSearchOption = $(".entity-option:checked").val();

var selectiontable = $('#selectiontable').DataTable(selectionTableConfig['tableSettings']);
var searchtable = $('#searchtable').DataTable(searchTableConfig['tableSettings']);

// ----  data table  ----
var searchtableContainer = document.getElementById("searchtable-container");


// function to create searchTable
function makeSearchTable(entityType){
  if ($.fn.DataTable.isDataTable("#searchtable")) {
    $('#searchtable').DataTable().clear().destroy();
    $('#searchtable').empty();
  }
  var tableSettings = searchTableConfig['tableSettings'];
  return $('#searchtable').DataTable(tableSettings);
}


// update searchTable
function updateTable(data, table){
  table.clear();

  for(var i in data) {
    table.row.add(data[i]);
  };
  table.draw();
}

var inputBar = document.getElementById("name-search-bar");
var searchButton = document.getElementById("search-btn");
var continueButton = document.getElementById("continue-btn");



// ----  listeners  ----

continueButton.addEventListener('click', function(){
   data = {
       option: latestSearchOption,
       keyword: latestSearchTerm,
       selfcite: false, //selfCiteCheckbox.checked,
       bot_year_min: 0,
       top_year_max: 3000
   }
   postData('/submit/', data, "{% csrf_token %}")
});

function search(){
  console.log("searching")
  latestSearchOption = $(".entity-option:checked").val();
  searchtable = makeSearchTable(latestSearchOption);
  latestSearchTerm = inputBar.value;

  // showProgressBar();
  $.ajax({
    type: "POST",
    url: "/search",
    data: { // input to the views.py - search()
      keyword: latestSearchTerm,
      option: latestSearchOption,
    },
    success: function (result) { // return data if success
      updateTable(result["entities"], searchtable);
      searchTableEventHandling();
      searchtable.rows().nodes().each(function(a) {
        selectiontable.rows().nodes().each(function(b) {
          var search_row = searchtable.row(a);
          var selection_row = selectiontable.row(b);
          if(search_row.data()['table-id'] === selection_row.data()['table-id']){
            search_row.select();
          }
        })
      });
      addNestedRows();
    },
    error: function (result) {
      console.log("searchButton error");
    }
  });
}

var searchButton = document.getElementById('search-btn');
var searchBar = document.getElementById('name-search-bar')
searchButton.addEventListener('click', function(){
  search();
});

// Search when enter pressed in input bar
searchBar.addEventListener('keypress', function (e) {
  var key = e.which || e.keyCode;
  if (key === 13) { // 13 is enter
    search();
  }
});

function searchTableEventHandling() {
  $('#searchtable tr').on('click', function () {
      var tr = $(this).closest('tr');
      var row = searchtable.row( tr );
      if (!tr.hasClass('selected')){
        var newRow = row.data();
        selectiontable.row.add(newRow).draw();
      }
      else {
        selectiontable.rows().nodes().each(function(a) {
          var r = selectiontable.row(a);
          if(r.data()['table-id'] === row.data()['table-id']){
            r.remove().draw();
          }
        });
      }
  })
};

$('#selectiontable tbody').on('click', 'tr', function () {
  var row = selectiontable.row( this );
  try {
    searchtable.rows().nodes().each(function(a) {
      var r = searchtable.row(a);
      if(r.data()['table-id'] === row.data()['table-id']){
        r.deselect();
      }
    });
    row.remove().draw();
  } catch (e) {}
});



// nested papers tables

var nested_tables = {};
var nestedTableSettings = nestedTableConfig['tableSettings'];
function addNestedRows(){
  searchtable.rows().every(function(rowIdx, tableLoop, rowLoop){
    console.log('triggered in searchtable row every');
    var eid = this.data()['data']['eid'];
    var tableId = eid;
    var child_text = "<table id='"+tableId+"' class='papers_table compact'></table>";
    this.child(child_text).show();
    var nestedTable = $("#" + tableId);
    nestedTable.closest("td").addClass("innertable");
    nested_tables[eid] = nestedTable.DataTable(nestedTableSettings);
    updateTable(this.data()['data']['papers'], nested_tables[eid]);

    this.child.hide();
  });

  addNestedRowToggle();
}

// Add event listener for opening and closing details
function addNestedRowToggle (){
  $('#searchtable tbody').on('click', 'td.details-control', function () {
  console.log('triggered in searchtable onclick ');
    var tr = $(this).closest('tr');
    var row = searchtable.row( tr );
    var show = !(row.child.isShown());
 
   // Close all open rows
    $('.shown').each( function (i, elem) {
      var tblRow = searchtable.row( elem );
      elem.classList.remove('shown');
      tblRow.child.hide();
    });

    if ( show ) {
        // Open this row
        row.child.show();
        tr.addClass('shown');
    }
  })
}

</script>
















