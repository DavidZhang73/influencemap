{% load staticfiles %}

<html>
  {% include 'header.html' %}
  <body>
    <div class="wrapper" align="center">
      {% include 'navbar.html' with navbar=navbarOption %}
      <div id="table-container" class="container">
        <table id="papers-table" class="row-border hover order-column" cellspacing="0" width="100%">
        </table>
        <input id="return-btn" type="submit" value="Return to search">
        <input id="submit-btn" type="submit" name="submit">
      <div class="search-option">
        <div class="checkbox">
          <label>
            <input class="self-cite" type="checkbox" name="self-cite" id="self-cite">
            include self citations
          </label>
        </div>
      </div>
     </div>
    </div>

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="{% static 'js/papersTableConfig.js' %}"></script>
<script>

var papersTableElement = document.getElementById('papers-table');
var submitButton = document.getElementById('submit-btn');
var returnButton = document.getElementById('return-btn');
var selfCiteCheckbox = document.getElementById('self-cite');
var papersTable = $('#papers-table').DataTable(papersTableConfig['author']['tableSettings']);

// update searchTable
function updateTable(data, table, resKeys, clear){
  console.log("updateTable");
  if (clear) {table.clear();}
  for(var i in data) {
    var newRow = {};
    for(var j in resKeys) {
       key = resKeys[j];
       newRow[j] = data[i][key];
    };
    if (resKeys.indexOf('field') >= 0){
      // fields
      fields = "";
      for (var f in newRow[3]) {
        field = newRow[3][f].split('_');
        fields += "<li>" + field[0] + " (" + field[1] + ")</li>";
      }
      newRow[3] = "<ul>" + fields + "</ul>";
    }

    table.row.add(newRow);
  };
  table.draw();
};

function capitalise_first_letter(word){
  return word.charAt(0).toUpperCase() + word.slice(1);
}

function title_case(sentence){
  var exceptions = ['a', 'an', 'the', 'and', 'but', 'or', 'for', 'nor','on','at','to','from','by'];
    word_list = sentence.split(' ');
    out = [capitalise_first_letter(word_list[0])];
    for (var i = 1; i < word_list.length; i++){
        var word = word_list[i];
        if (exceptions.indexOf(word) < 0){ 
          out.push(capitalise_first_letter(word))
        } else {
          out.push(word)
        }
    }
    return out.join(" ");
}

var selectedInfo = {{ entityTuples | safe}};
var papersDict = {{ papersDict | safe }};
var entityType = '{{ entityType }}';

var responseKeys = papersTableConfig[entityType]['responseKeys'];

var keyword = '{{ keyword }}';

updateTable(selectedInfo, papersTable, responseKeys, true);

// split and capitalise paper lists
for (var key in papersDict){
  for (var i in papersDict[key]){
    papersDict[key][i]['title'] = title_case(papersDict[key][i]['title'])
  }
}

var nested_tables = {};

// add all nested data tables
papersTable.rows().every(function(rowIdx, tableLoop, rowLoop){
  var eid = this.data()[5];
  var tableId = eid;
  var child_text = "<table id='"+tableId+"' class='author_papers'></table>";
  this.child(child_text).show();
  var tableSelector = "#" + tableId;
  nested_tables[eid] = $(tableSelector).DataTable(papersTableConfig['all']['tableSettings']);
  var childResponseKeys = papersTableConfig['all']['responseKeys'];
  updateTable(papersDict[eid], nested_tables[eid], childResponseKeys, true);
  this.child.hide();
});



// Submit Button event handler
submitButton.addEventListener('click', function(){
  console.log('submit button clicked');
  showProgressBar();

  var selected_papers = {};
  var unselected_papers = {};
  papersTable.rows().every(function(rowIdx, tableLoop, rowLoop){
    var table_dom = this.child().find('table')[0]     
    var table_id = table_dom.id;
    selected_papers[table_id] = [];
    unselected_papers[table_id] = [];
    var data_table = nested_tables[table_id];
    data_table.rows().every(function (ri, tl, rl){
      var node = this.node();
      var row_checked = ($(node).find('input').prop('checked'));
      if (row_checked) { 
        selected_papers[table_id].push(this.data()[3]) 
      } else {
        unselected_papers[table_id].push(this.data()[3])
      }
    });
  });

  
  for (var key in selected_papers) {
    if (selected_papers[key].length > 0) {
      selected_papers[key] = key + ":" + selected_papers[key].join() 
    } else {
      delete selected_papers[key];
    }
  };
  var selected_papers_str = Object.values(selected_papers).join('_entity_');
  
  for (var key in unselected_papers) {
    if (unselected_papers[key].length > 0) {
      unselected_papers[key] = key + ":" + unselected_papers[key].join() 
    } else {
      delete unselected_papers[key];
    }
  };
  var unselected_papers_str = Object.values(unselected_papers).join('_entity_');



   data = {
       papers: selected_papers_str,
       unselected_papers: unselected_papers_str,
       option: entityType,
       keyword: keyword,
       selfcite: selfCiteCheckbox.checked,
   }
   window.location.href = "/submit/?" + $.param(data);
});


function childrowDataTable(data) {
  var eid = d[5];
  var papers = papersDict[eid];
  var dt = DataTable
}

// Add event listener for opening and closing details
$('#papers-table tbody').on('click', '.outer-table-row', function () {
    var tr = $(this).closest('tr');
    var row = papersTable.row( tr );
    var show = !(row.child.isShown());
 
   // Close all open rows
    $('.shown').each( function (i, elem) {
      var tblRow = papersTable.row( elem );
      elem.classList.remove('shown');
      tblRow.child.hide();
    });

    if ( show ) {
        // Open this row
        row.child.show();
        tr.addClass('shown');
    }
})


$(document).ready(function() {
  hideProgressBar();
});

</script>


  </body>
</html>
~
